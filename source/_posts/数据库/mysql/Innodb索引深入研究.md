---
title: Innodb索引深入研究
tags:
  - innodb
  - 索引
  - 读书笔记
categories:
  - 数据库
  - mysql
abbrlink: 27224
date: 2022-04-08 11:03:28
updated: 2022-04-08 11:03:28
---

之前对索引这块有所了解，也按照一些索引优化实践对表进行过优化，但都是一知半解，不清楚为什么要这么做。本篇文章会对Innodb索引是怎么存储以及怎么使用的进行深入的研究，从而理解索引优化的原理，最后会对索引的使用进行总结。

## 索引存储结构

先来看下Innodb是如何存储数据。
![主键索引](https://cdn.jsdelivr.net/gh/fengxiu/img/20220408142245.png)

从上图可以看出，最下层存储的是相关的记录，上面一层存储的是目录项，其实就是主键索引。目录项存储格式和存储真实记录的格式一样，具体的行格式可以参考[InnoDB行格式](https://fengxiu.tech/archives/43453.html)，只不过是存储的内容不一样，目录项存储的内容是主键值和其对应的页号。

通过目录项就可以根据主键id快速找到对应的记录，具体的查找过程如下

1. 确定存储主键id对应的目录页
2. 通过存储目录项记录的页确定用户记录真正所在的页
3. 在真正存储用户记录的页中定位到具体的记录

另外在Innodb中，每个数据页的大小是16KB，上面存储目录的页和存储数据的页都叫做数据页，因此每页能存储的目录项是确定的，当超出大小时，就会产生一个新的目录页来存储对应的目录。最终会产生出下面这种样式的存储结构，类似于多级目录，大的目录页里嵌套小的目录页。存储数据的页当超出能存储的最大数据记录个数时，也会创建一个新的页面存储，但是只会在最下面一层。
![](https://cdn.jsdelivr.net/gh/fengxiu/img/20220408150150.png)

上面描述的结构其实就是B+树。具体什么是B+树介绍的文章比较多，这里就不在具体阐述，只需要明白Innodb是如何存储数据的即可。

下面介绍几个概念

1. 聚簇索引： 数据和索引存储在一块，上面描述的主键索引就是聚簇索引。
2. 二级索引： 非主键索引以外的索引都可以叫做二级索引，这种索引和主键索引存储结构是一样，只是记录的数据有区别，在目录项中记录的是二级索引对应的列、主键以及页地址，数据记录中记录的是列值和主键值。因此当使用二级索引查找数据时，仅仅只是找到了对应的主键值，还需要根据主键值在主键索引中查找对应的数据，级回表操作。
3. 联合索引： 多列组合在一起的索引，也属于二级索引，区别是存储多个列。

<!-- ### Innodb中B+树索引一些规定

1. 根页面地址始终不变：B+树实际创建索引的过程如下，每次创建索引时都会创建一个根节点页面，在往表中插入数据时都会插入对应的索引到这个根节点页面，当页面可用空间用完后，会创建一个新的页面，
    1. 每当为某个表创建一个 树索引(聚簇索引不是人为创建的它默认就存在〉时，都会为这个索引创建一个根节点页面。最开始表中没有数据的时候，每个B+ 树索引对应的根节点中既没有用户 ，也没有目录项记录.
    2. 随后向表中插入用户记录时 先把用户记录存储到这个根节点中。
    3. 在根节点中的可用空间用完时继续插入记录，此时会将根节点中的所有记录复制到一个新分配的页(比如页 a) 中， 然后对这个新页进行页分裂操作，得到另一个新页(比如页 ). 这时新插入的记录会根据键值(也就是聚簇索引中的主键值，或二级索引中对应的索引列的值〉的大小分配到页 或页 中.根节点此时便升级为存储目录项记录的页 ，也就需要把页 和页 对应的目录项记录插入到根节点中。

在这个过程中，需要特别注意 一个 树索引的根节点自创建之日起便不会再移动(也就是页号不再改变).这样只要我们对某个表建立一个索引 ，那么它的根节点的页号便会被记录到某个地方，后续凡是 InnoDB 存储引擎需要用到这个索引时，都会从那个固定的地方取出根节点的页号，从而访问这个索引.

2. 内节点中目录项记录的唯一性。这个是通过在目录相中记录相关的主键key值来保证。可以方便定位唯一的目录页。
3. 一个页面至少有俩条记录。 -->

### 索引优缺点

索引的优点当然是能够加速查找，缺点有俩点，空间： 创建一个新的索引，就会将对应的结构存储到磁盘上，会增加存储的代价。时间： 虽然索引能够增加查询的速度，但是对于增删改操作时，不仅需要完成操作本身，还需要操作对应的索引，因此会增加相应的时间成本。

## 应用索引



## 参考

1. Mysql是怎样运行的



Innodb 索引结构是怎样的
使用索引带来的问题
